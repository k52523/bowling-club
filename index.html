<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë³¼ë§í´ëŸ½ ë©”ì¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="css/main.css">
</head>
<body>

<div class="navbar" style="width:100%;max-width:480px;margin:0 auto;box-sizing:border-box;padding:12px 0 10px 0;text-align:center;font-size:1.5em;background:#2368b3;color:#fff;box-shadow:0 2px 9px #2368b366;">
  ğŸ³ ë³¼ë§í´ëŸ½
</div>

  <div class="main-content">
    <h2>í´ëŸ½ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</h2>
    
	<!-- ìƒì¼ -->    
	<div id="home-birthday-banner"></div>	
	
    <!-- ì ìˆ˜ í‘œ (ì‹¤ì œ ë°ì´í„° ìˆì„ ë•Œë§Œ ì¶œë ¥) -->
    <div id="home-score-table" style="margin-bottom:30px;"></div>

    <div class="tip-card">
      <h3>ğŸ³ ë³¼ë§ íˆ¬êµ¬ ì²´í¬ë¦¬ìŠ¤íŠ¸ (ì‹¤ì „ í”„ë¡œ íŒ)</h3>
      <ul>
        <li><b>ëª¸ì— í˜ì„ ë¹¼ë¼</b><br><span class="desc">â†’ ê²½ì§ëœ ê·¼ìœ¡ì€ íˆ¬êµ¬ì˜ ë¶€ë“œëŸ¬ì›€ê³¼ íšŒì „ì„ ë°©í•´í•¨.<br><span class="tip">Tip:</span> í˜ì„ ë¹¼ë©´ ìŠ¤ìœ™ì´ ìì—°ìŠ¤ëŸ½ê³ , ë¶€ìƒ ìœ„í—˜ë„ ì¤„ì–´ë“¬.</span></li>
        <li><b>ê³µì„ â€˜ë°€ì§€â€™ ë§ê³  â€˜íˆ­â€™ ë–¨ì–´ëœ¨ë ¤ë¼</b><br><span class="desc">â†’ íŒŒìš¸ì„  ì•ì—ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ë°”ë‹¥ì— ë–¨ì–´ì§€ë„ë¡.<br><span class="tip">Tip:</span> ê³µì´ ë©€ë¦¬ ë‚ ì•„ê°€ë©´ íšŒì „ê³¼ ë¼ì¸ ì»¨íŠ¸ë¡¤ì´ ì–´ë ¤ì›Œì§.</span></li>
        <li><b>ì •í™•í•œ íƒ€ê²Ÿ ë³´ë“œ(ìŠ¤íŒŸ)ì— â€˜íˆ­â€™!</b><br><span class="desc">â†’ í•­ìƒ ê°™ì€ ì§€ì ì„ ë³´ê³  ê³µì„ ë‚´ë ¤ë†“ëŠ” ìŠµê´€.<br><span class="tip">Tip:</span> â€˜ìµìˆ™í•œâ€™ ë³´ë“œë¥¼ ì •í•´ë‘ë©´ ì¼ê´€ì„±â†‘.</span></li>
        <li><b>íšŒì „ì„ â€˜ì˜ì‹ì ìœ¼ë¡œâ€™ ë§Œë“¤ì§€ ë§ˆë¼</b><br><span class="desc">â†’ ì†ëª©ì„ ì¼ë¶€ëŸ¬ ëŒë¦¬ë ¤ê³  í•˜ì§€ ì•ŠëŠ”ë‹¤.<br><span class="tip">Tip:</span> ì–µì§€ë¡œ ë¹„í‹€ë©´ ì˜¤íˆë ¤ â€˜ë”¸ë ¤ê°„ë‹¤â€™. ìì—°ìŠ¤ëŸ½ê²Œ!</span></li>
        <li><b>ì—„ì§€ ë¨¼ì €, ì¤‘Â·ì•½ì§€ë¡œ ë§ˆë¬´ë¦¬!</b><br><span class="desc">â†’ ì—„ì§€ê°€ ë¹ ì§ˆ ë•Œ ìì—°ìŠ¤ëŸ½ê²Œ ì¤‘Â·ì•½ì§€ì— â€˜í˜â€™ì´ ê±¸ë ¤ íšŒì „ ë°œìƒ.<br><span class="tip">Tip:</span> ì–µì§€ë¡œ í˜ ë¹¼ì§€ ë§ê³ , ì¤‘Â·ì•½ì§€ì— â€˜ê±¸ë¦¬ê¸°â€™ë§Œ ì‹ ê²½.</span></li>
        <li><b>ì—„ì§€ íƒ€ì´ë° = ê³µì´ ë°”ë‹¥ì— â€˜ë‹¿ê¸° ì§ì „â€™</b><br><span class="desc">â†’ ë„ˆë¬´ ì¼ì° ë¹¼ë©´ ë˜ì§€ê¸°, ë„ˆë¬´ ëŠ¦ìœ¼ë©´ ë•…ì— â€˜ë‚´ë ¤ì°ê¸°â€™ ë¨.<br><span class="tip">Tip:</span> ë§ˆì§€ë§‰ â€˜ìˆœê°„â€™ì— ì—„ì§€ê°€ ë¹ ì§€ë„ë¡ ì˜ì‹!</span></li>
        <li><b>íŒŒì´ë¸ŒìŠ¤í…, ë¬´ê²Œì¤‘ì‹¬ì€ â€˜ì•„ë˜â€™ë¡œ</b><br><span class="desc">â†’ ìŠ¤í…ë§ˆë‹¤ í•˜ì²´ ì¤‘ì‹¬ì„ ê¹”ê³ , ëª©í‘œ ë³´ë“œë¡œ ì§ì§„.<br><span class="tip">Tip:</span> ìƒì²´ í˜ì„ ë¹¼ê³  í•˜ì²´ë¡œ ë¯¸ëŠ” ëŠë‚Œ.</span></li>
      </ul>
      <div class="routine">
        <b>ğŸ† í”„ë¡œí˜ì…”ë„ íˆ¬êµ¬ ë£¨í‹´</b><br>
        <i>â€œí˜ì„ ë¹¼ê³ , ëª©í‘œ ë³´ë“œì— ê³µì„ íˆ­! ì—„ì§€ ë¹ ì§€ëŠ” íƒ€ì´ë°ì—ë§Œ ì§‘ì¤‘, ë‚˜ë¨¸ì§€ëŠ” ì¤‘Â·ì•½ì§€ì— ë§¡ê¸´ë‹¤.â€</i>
      </div>
    </div>
  </div>
 
  <div id="bottom-nav-container"></div>

  <!-- Firebase ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
 
  <script>
	fetch('bottom-nav.html')
	  .then(res => res.text())
	  .then(html => {
		document.getElementById('bottom-nav-container').innerHTML = html;
	  });

</script>

  <script>
    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyBoVtFKGoy0pzuwFj9s3L0jhz95yZw0Uns",
      authDomain: "bowlingclub-a7f4a.firebaseapp.com",
      projectId: "bowlingclub-a7f4a",
      storageBucket: "bowlingclub-a7f4a.appspot.com",
      messagingSenderId: "564414783398",
      appId: "1:564414783398:web:7bda19088ff01e697df967",
      measurementId: "G-9NMMNGZR14"
    };
    firebase.initializeApp(firebaseConfig);

    // ìµœê·¼ 3ì¼ê°„ ë‚ ì§œë³„ ì ìˆ˜í‘œ
async function showRecentScores() {
  const db = firebase.firestore();
  const snapshot = await db.collection('sessions').get();
  const data = snapshot.docs.map(doc => doc.data());

  // 1. ë‚ ì§œë³„ë¡œ ë¬¶ê¸°
  const byDate = {};
  data.forEach(item => {
    if (!byDate[item.date]) byDate[item.date] = [];
    byDate[item.date].push(item);
  });

  // 2. ìµœê·¼ 3ì¼ ì¶”ì¶œ(ë‚´ë¦¼ì°¨ìˆœ)
  const dates = Object.keys(byDate).sort((a, b) => new Date(b) - new Date(a)).slice(0, 3);

  let html = "";
  dates.forEach(date => {
    const sessions = byDate[date];
    // íšŒì›ëª… ê¸°ì¤€ìœ¼ë¡œ ê²Œì„ë²ˆí˜¸ë³„ ì ìˆ˜+ìƒíƒœ ë°°ì—´ ë§Œë“¤ê¸°
    const userMap = {};
    let maxGame = 0;
    sessions.forEach(sess => {
      sess.players.forEach(pl => {
        if (!userMap[pl.name]) userMap[pl.name] = {};
        userMap[pl.name][sess.gameNum] = {
          score: pl.score,
          isPerfect: pl.isPerfect,
          isCover: pl.isCover
        };
        if (sess.gameNum > maxGame) maxGame = sess.gameNum;
      });
    });
    maxGame = Math.max(maxGame, 1);

    let userArr = Object.keys(userMap).map(name => {
      let scores = [];
      for(let i=1;i<=maxGame;i++) {
        const v = userMap[name][i];
        scores.push(v !== undefined ? v : null);
      }
      // í‰ê·  ê³„ì‚° (ìˆ«ìë§Œ ëŒ€ìƒìœ¼ë¡œ)
      const numScores = scores.filter(x => x && typeof x.score === 'number').map(x=>x.score);
      const avg = numScores.length ? Math.round((numScores.reduce((a, b) => a+b, 0)/numScores.length)*10)/10 : 0;
      return { name, scores, avg };
    });
    // ì ìˆ˜ í•˜ë‚˜ë¼ë„ ìˆëŠ” ìœ ì €ë§Œ í‘œì‹œ
    userArr = userArr.filter(u => u.scores.some(s => s && s.score !== undefined));
    if (userArr.length === 0) return;

    // í‰ê·  ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ ë° ìˆœìœ„
    userArr.sort((a, b) => b.avg - a.avg);
    userArr.forEach((u,i)=>u.rank=i+1);

    // ë‚ ì§œ í‘œê¸° ë³€í™˜
    const d = new Date(date);
    const dateStr = `${d.getFullYear()}ë…„ ${d.getMonth()+1}ì›” ${d.getDate()}ì¼`;

    html += `<h3 style="margin-top:2em; font-size:1.15em; color:#333;">${dateStr}</h3>
    <div class="responsive-table-wrap">
      <table>
        <tr>
          <th>ì´ë¦„</th>`;
    for(let i=1;i<=maxGame;i++) html += `<th>${i}G</th>`;
    html += `<th>av</th><th>ìˆœìœ„</th></tr>`;
    userArr.forEach(u=>{
      html += `<tr><td>${u.name}</td>`;
      u.scores.forEach(s=>{
        let style = "";
        if (s && s.isPerfect) style = ' style="background:red;font-weight:bold;"';
        else if (s && s.isCover) style = ' style="background:gold;font-weight:bold;"';
        html += `<td${style}>${s && s.score!==undefined ? s.score : ""}</td>`;
      });
      html += `<td>${u.avg}</td><td>${u.rank}</td></tr>`;
    });
    html += `</table></div>`;
  });

  // ì ìˆ˜ ë°ì´í„°ê°€ ìˆì„ ë•Œë§Œ í…Œì´ë¸” í‘œì‹œ, ì—†ìœ¼ë©´ ì•„ë¬´ê²ƒë„ X
  document.getElementById('home-score-table').innerHTML = html;
}




    // í‘œ ì‹¤í–‰
    showRecentScores();
	
	async function showUpcomingBirthdays() {
  const db = firebase.firestore();
  const snapshot = await db.collection('users').get();
  const members = snapshot.docs.map(doc => doc.data());
  const today = new Date();

  // ìƒì¼ ë‚ ì§œ ë° ë‚¨ì€ ì¼ìˆ˜ ê³„ì‚°
  const result = members
    .filter(m => m.birthday)
    .map(m => {
      const [year, month, day] = m.birthday.split('-');
      let nextBirthday = new Date(today.getFullYear(), parseInt(month) - 1, parseInt(day));
      if (nextBirthday < today) nextBirthday.setFullYear(today.getFullYear() + 1);
      const diff = Math.floor((nextBirthday - today) / (1000 * 60 * 60 * 24));
      return { ...m, nextBirthday, diff };
    })
    // 18ê°œì›” ì´ë‚´ë§Œ
    .filter(m => m.diff >= 0 && m.diff <= 30)
    // "ë‚¨ì€ ì¼ìˆ˜" ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
    .sort((a, b) => a.diff - b.diff);

  if (result.length > 0) {
    let html = `
    <div class="birthday-card">
      <div class="birthday-card-title">
        <span class="bday-emoji">ğŸ‚</span>  
        <span>ë‹¤ê°€ì˜¤ëŠ” ìƒì¼ì¸ íšŒì›</span>
      </div>
      <div class="birthday-card-list">
        ${result.map(m => `
          <div class="bday-member">
            <span class="bday-icon">ğŸ¥³</span>
            <span class="bday-name">${m.name}</span>
            <span class="bday-date">${("0" + (m.nextBirthday.getMonth() + 1)).slice(-2)}/${("0" + m.nextBirthday.getDate()).slice(-2)}</span>
            <span class="bday-cake">ğŸ°</span>
          </div>
        `).join('')}
      </div>
    </div>
    `;
    document.getElementById('home-birthday-banner').innerHTML = html;
  } else {
    document.getElementById('home-birthday-banner').innerHTML = '';
  }
}
showUpcomingBirthdays();

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBoVtFKGoy0pzuwFj9s3L0jhz95yZw0Uns",
      authDomain: "bowlingclub-a7f4a.firebaseapp.com",
      projectId: "bowlingclub-a7f4a",
      storageBucket: "bowlingclub-a7f4a.appspot.com",
      messagingSenderId: "564414783398",
      appId: "1:564414783398:web:7bda19088ff01e697df967",
      measurementId: "G-9NMMNGZR14"
    };

  firebase.initializeApp(firebaseConfig);

  function updateLoginoutBtn() {
    const btn = document.getElementById('loginout-btn');
    if (!btn || typeof firebase === "undefined" || !firebase.auth) return;
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        btn.innerHTML = 'ğŸšª ë¡œê·¸ì•„ì›ƒ';
        btn.href = "#";
        btn.onclick = function() {
          firebase.auth().signOut().then(() => location.reload());
          return false;
        };
      } else {
        btn.innerHTML = 'ğŸ‘¤ ë¡œê·¸ì¸';
        btn.href = "login.html";
        btn.onclick = null;
      }
    });
  }

  fetch('bottom-nav.html')
    .then(response => response.text())
    .then(html => {
      document.getElementById('bottom-nav-container').innerHTML = html;
      updateLoginoutBtn();
    });
</script>
</body>
</html>
