<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê²½ê¸° ì„¸ì…˜ ê¸°ë¡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="css/main.css" />

<style>
#players > div {
  display: flex;
  align-items: center;
  gap: 10px;      /* ì „ì²´ ìš”ì†Œ ì‚¬ì´ */
  margin-bottom: 8px;
  flex-wrap: nowrap;
}

#players select {
  width: 110px;   /* ì´ë¦„ ì„ íƒ ë„“ê²Œ! */
  min-width: 90px;
  max-width: 140px;
  flex: 0 0 auto;
  margin-bottom: 0;
}

#players input[type="number"] {
  width: 60px;    /* ì ìˆ˜ëŠ” ë”± 3ìë¦¬ */
  min-width: 50px;
  max-width: 70px;
  text-align: center;
  margin-bottom: 0;
  padding-left: 0;
  padding-right: 0;
}

#players label {
  display: flex;
  align-items: center;
  gap: 3px;              /* ì²´í¬ë°•ìŠ¤ ë‚´ë¶€ ì•„ì´ì½˜-í…ìŠ¤íŠ¸ ê°„ê²© */
  margin: 0 8px 0 0;     /* ì²´í¬ë°•ìŠ¤ ì‚¬ì´ ì˜¤ë¥¸ìª½ ì—¬ë°± */
  font-weight: 500;
  font-size: 1em;
  white-space: nowrap;
}

#players label:last-child {
  margin-right: 0; /* ë§ˆì§€ë§‰ì€ ì˜¤ë¥¸ìª½ ì—¬ë°± ì œê±° */
}

@media (max-width:480px) {
  #players select { width: 80px; }
  #players input[type="number"] { width: 44px; }
  #players label { font-size: 0.96em; margin-right: 5px; }
  #players > div { gap: 6px; }
}

</style>



</head>
<body>
  <div id="header-area"></div>
  <div class="main-content">
    <h2>ê²½ê¸° ì„¸ì…˜ ê¸°ë¡</h2>
    <form id="sessionForm" class="session-form" autocomplete="off">
      <label>ë‚ ì§œ</label>
      <input type="date" id="date" required>
      <div style="display:flex; gap:8px; margin-bottom:6px;">
        <div style="flex:1;">
          <label style="margin-top:0;">ë ˆì¸ ë²ˆí˜¸</label>
          <input type="number" id="lane" min="1" required>
        </div>
        <div style="flex:1;">
          <label style="margin-top:0;">ê²Œì„ ë²ˆí˜¸</label>
          <input type="number" id="gameNum" min="1" required>
        </div>
      </div>
      <label>ì°¸ê°€ì(íšŒì›) ì„ íƒ</label>
      <div id="players"></div>
      <button type="button" id="addPlayer" class="main-btn" style="margin:7px 0 12px 0;background:#4b96f7;font-size:1em;">+ ì°¸ê°€ì ì¶”ê°€</button>
      <label>íŠ¹ì´ì‚¬í•­(ë©”ëª¨)</label>
      <input type="text" id="memo" maxlength="60" style="width:100%;" placeholder="ì¤‘ê°„í•©ë¥˜/êµì²´ ë“±">
      <button type="submit" class="main-btn">ì €ì¥</button>
    </form>
    <div id="sessionMsg"></div>
  </div>

  <div id="bottom-nav-container"></div>

  <script>
    fetch('header.html').then(res => res.text()).then(html => document.getElementById('header-area').innerHTML = html);

fetch('bottom-nav.html')
  .then(res => res.text())
  .then(html => {
    document.getElementById('bottom-nav-area').innerHTML = html;
    setTimeout(updateLoginoutBtn, 250);  // ë°˜ë“œì‹œ fetch ì•ˆì—ì„œ í˜¸ì¶œ
  });


  </script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    // ì˜¤ëŠ˜ ë‚ ì§œ ìë™ ì…ë ¥ í•¨ìˆ˜
    function setTodayDate() {
      const dateInput = document.getElementById('date');
      if (!dateInput) return;
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      dateInput.value = `${yyyy}-${mm}-${dd}`;
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë‚ ì§œ ìë™ ì…ë ¥
    window.onload = function() {
      setTodayDate();
    };

    // Firebase ì´ˆê¸°í™”
    const firebaseConfig = {
      apiKey: "AIzaSyBoVtFKGoy0pzuwFj9s3L0jhz95yZw0Uns",
      authDomain: "bowlingclub-a7f4a.firebaseapp.com",
      projectId: "bowlingclub-a7f4a",
      storageBucket: "bowlingclub-a7f4a.appspot.com",
      messagingSenderId: "564414783398",
      appId: "1:564414783398:web:7bda19088ff01e697df967",
      measurementId: "G-9NMMNGZR14"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // íšŒì› ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° (users ì»¬ë ‰ì…˜)
    let memberList = [];
    db.collection('users').orderBy("name").get().then(qs => {
      memberList = qs.docs.map(doc => ({id: doc.id, name: doc.data().name}));
      updateAllSelects();
    });

    function updateAllSelects() {
      document.querySelectorAll('.player-select').forEach(sel => {
        const selected = sel.value;
        const selectedIds = Array.from(document.querySelectorAll('.player-select'))
          .map(s => s.value).filter(v => v && v !== selected);
        sel.innerHTML = `<option value="">íšŒì› ì„ íƒ</option>` +
          memberList.map(m =>
            selectedIds.includes(m.id) && m.id !== selected
              ? '' : `<option value="${m.id}">${m.name}</option>`
          ).join('');
        sel.value = selected;
      });
    }

    // ì°¸ê°€ì ë™ì  ì¶”ê°€/ì‚­ì œ (ë“œë¡­ë‹¤ìš´ + ì²´í¬ë°•ìŠ¤)
    const playersDiv = document.getElementById('players');

function addPlayerRow(selectedId='', score='', isCover=false, isPerfect=false) {
  const row = document.createElement('div');
  row.innerHTML = `
    <select class="player-select"></select>
    <input type="number" min="0" max="300" placeholder="ì ìˆ˜" value="${score}">
    <label><input type="checkbox" class="cover-check"${isCover?' checked':''}> All</label>
    <label><input type="checkbox" class="perfect-check"${isPerfect?' checked':''}> Per</label>
  `;
  // í¼í™íŠ¸ ìë™ ì²´í¬ (300ì  ì…ë ¥ì‹œ)
  const scoreInput = row.querySelector('input[type="number"]');
  const perfectCheck = row.querySelector('.perfect-check');
  scoreInput.addEventListener('input', function() {
    if(this.value == 300) perfectCheck.checked = true;
  });
  playersDiv.appendChild(row);
  updateAllSelects();
  if (selectedId) row.querySelector('.player-select').value = selectedId;
}

    document.getElementById('addPlayer').onclick = () => addPlayerRow();
    addPlayerRow(); // ì‹œì‘ì‹œ 1ëª… ê¸°ë³¸

    // í¼ ì €ì¥
    document.getElementById('sessionForm').onsubmit = async function(e) {
      e.preventDefault();
      const date   = document.getElementById('date').value;
      const lane   = Number(document.getElementById('lane').value);
      const gameNum= Number(document.getElementById('gameNum').value);
      const memo   = document.getElementById('memo').value.trim();
      const players= [...playersDiv.querySelectorAll('div')].map(row => {
        const userId = row.querySelector('.player-select').value;
        const user = memberList.find(m => m.id === userId);
        const scoreVal = row.querySelector('input[type="number"]').value;
        return {
          userId,
          name: user ? user.name : "",
          score: scoreVal ? Number(scoreVal) : null,
          isCover: row.querySelector('.cover-check').checked,
          isPerfect: row.querySelector('.perfect-check').checked
        }
      }).filter(p => p.userId);
      if (!players.length) {
        document.getElementById('sessionMsg').textContent = "ìµœì†Œ í•œ ëª… ì´ìƒì˜ ì°¸ê°€ìë¥¼ ì„ íƒí•˜ì„¸ìš”.";
        return;
      }
      try {
        await db.collection('sessions').add({
          date,
          lane,
          gameNum,
          players,
          memo,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('sessionMsg').textContent = "ì €ì¥ ì™„ë£Œ!";
        this.reset();
        setTodayDate();  // â˜… ì €ì¥ í›„ì—ë„ ë‚ ì§œ ìë™ ì…ë ¥
        playersDiv.innerHTML = "";
        addPlayerRow();
      } catch(err) {
        document.getElementById('sessionMsg').textContent = "ì €ì¥ ì‹¤íŒ¨: " + err.message;
      }
    }


<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBoVtFKGoy0pzuwFj9s3L0jhz95yZw0Uns",
      authDomain: "bowlingclub-a7f4a.firebaseapp.com",
      projectId: "bowlingclub-a7f4a",
      storageBucket: "bowlingclub-a7f4a.appspot.com",
      messagingSenderId: "564414783398",
      appId: "1:564414783398:web:7bda19088ff01e697df967",
      measurementId: "G-9NMMNGZR14"
    };

  firebase.initializeApp(firebaseConfig);

  function updateLoginoutBtn() {
    const btn = document.getElementById('loginout-btn');
    if (!btn || typeof firebase === "undefined" || !firebase.auth) return;
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        btn.innerHTML = 'ğŸšª ë¡œê·¸ì•„ì›ƒ';
        btn.href = "#";
        btn.onclick = function() {
          firebase.auth().signOut().then(() => location.reload());
          return false;
        };
      } else {
        btn.innerHTML = 'ğŸ‘¤ ë¡œê·¸ì¸';
        btn.href = "login.html";
        btn.onclick = null;
      }
    });
  }

  fetch('bottom-nav.html')
    .then(response => response.text())
    .then(html => {
      document.getElementById('bottom-nav-container').innerHTML = html;
      updateLoginoutBtn();
    });
</script>

</body>
</html>
